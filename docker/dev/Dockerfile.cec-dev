# docker/dev/Dockerfile.cec-dev
FROM python:3.12-slim-bookworm

# Install system dependencies
WORKDIR /app
ENV DEBIAN_FRONTEND=noninteractive
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        libegl1-mesa \
        libglvnd0 \
        git \
        build-essential \
        pkg-config \
        cmake \
        libgl1-mesa-glx \
        libglib2.0-0 \
        ffmpeg \
        # Development tools
        curl \
        wget \
        jq \
        vim \
        # For debugging
        strace \
        procps \
        && \
    mkdir -p /usr/share/glvnd/egl_vendor.d && \
    echo '{"file_format_version":"1.0.0","ICD":{"library_path":"/usr/lib/x86_64-linux-gnu/libEGL_nvidia.so.0"}}' \
        >/usr/share/glvnd/egl_vendor.d/10_nvidia.json && \
    apt-get autoremove -y && \
    apt-get autoclean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Copy uv binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Create user with proper permissions
ARG UID=1000
ARG GID=1000
RUN groupadd -g $GID comfy || true && \
    useradd -m -u $UID -g $GID -s /bin/bash comfy || true

# Environment setup for UV and Python
ENV PYTHONUNBUFFERED=1 \
    UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=hardlink \
    UV_PROJECT_ENVIRONMENT=/opt/venv

# GPU environment variables
ENV NVIDIA_DRIVER_CAPABILITIES="all" \
    NVIDIA_VISIBLE_DEVICES="all" \
    MESA_D3D12_DEFAULT_ADAPTER_NAME="NVIDIA" \
    LD_LIBRARY_PATH=/usr/lib/wsl/lib \
    WINDOW_BACKEND="headless" \
    DOCKER_RUNTIME="1"

# Create directories with proper permissions
RUN mkdir -p /workspace/cec /env /opt/venv /home/comfy/.cache/uv && \
    chown -R comfy:comfy /workspace /env /opt/venv /home/comfy

# Switch to user
USER comfy
WORKDIR /workspace/cec

# Set up PATH to include venv
ENV PATH="/opt/venv/bin:$PATH"
ENV PYTHONPATH="/workspace/cec/src:$PYTHONPATH"

# Create shell configuration
RUN echo '# UV workspace development' >> ~/.bashrc && \
    echo 'export PATH="/opt/venv/bin:$PATH"' >> ~/.bashrc && \
    echo '' >> ~/.bashrc && \
    echo '# Check if we need to sync on shell start' >> ~/.bashrc && \
    echo 'if [ -f "/workspace/cec/pyproject.toml" ] && [ ! -f "/opt/venv/pyvenv.cfg" ]; then' >> ~/.bashrc && \
    echo '    echo "Setting up CEC development environment..."' >> ~/.bashrc && \
    echo '    cd /workspace/cec && uv sync --frozen' >> ~/.bashrc && \
    echo 'fi' >> ~/.bashrc && \
    echo '' >> ~/.bashrc && \
    echo '# Development aliases' >> ~/.bashrc && \
    echo 'alias ll="ls -la"' >> ~/.bashrc && \
    echo 'alias cec="uv run cec"' >> ~/.bashrc && \
    echo 'alias pytest="uv run pytest"' >> ~/.bashrc && \
    echo 'alias ipython="uv run ipython"' >> ~/.bashrc && \
    echo 'alias ruff="uv run ruff"' >> ~/.bashrc && \
    echo '' >> ~/.bashrc && \
    echo 'cd /workspace/cec' >> ~/.bashrc

# Development entrypoint script
RUN mkdir -p ~/.local/bin
RUN echo '#!/bin/bash' > ~/.local/bin/dev-entrypoint.sh && \
    echo 'set -e' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '# Ensure we have the right Python version' >> ~/.local/bin/dev-entrypoint.sh && \
    echo 'if ! command -v python3.12 &> /dev/null; then' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '    echo "Installing Python 3.12..."' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '    uv python install 3.12' >> ~/.local/bin/dev-entrypoint.sh && \
    echo 'fi' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '# Execute command or start shell' >> ~/.local/bin/dev-entrypoint.sh && \
    echo 'if [ $# -eq 0 ]; then' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '    exec /bin/bash' >> ~/.local/bin/dev-entrypoint.sh && \
    echo 'else' >> ~/.local/bin/dev-entrypoint.sh && \
    echo '    exec "$@"' >> ~/.local/bin/dev-entrypoint.sh && \
    echo 'fi' >> ~/.local/bin/dev-entrypoint.sh && \
    chmod +x ~/.local/bin/dev-entrypoint.sh

ENTRYPOINT ["/home/comfy/.local/bin/dev-entrypoint.sh"]